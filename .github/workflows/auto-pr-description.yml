name: Gemini PR Auto-Description

on:
  pull_request:
    types: [ opened ]

jobs:
  gemini-summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Summary and Update PR
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const { execSync } = require('child_process');

            // 1. ë°ì´í„° ì¶”ì¶œ (ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ ê¸°ë³¸ê°’ ì„¤ì •)
            let diff = "";
            let commits = "";
            let diffStat = "";

            try {
              const baseRef = 'origin/${{ github.base_ref }}';
              diff = execSync(`git diff ${baseRef}...HEAD | head -c 50000`).toString();
              diffStat = execSync(`git diff --stat ${baseRef}...HEAD`).toString();
              commits = execSync(`git log ${baseRef}...HEAD --pretty=format:"- %s"`).toString();
            } catch (e) {
              console.error("Git ë°ì´í„° ì¶”ì¶œ ì¤‘ ì—ëŸ¬ ë°œìƒ:", e);
              diff = "ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨";
            }

            // 2. PR í…œí”Œë¦¿ ì •ì˜
            const PR_TEMPLATE = `
            ## #ï¸âƒ£ ë³€ê²½ ì‚¬í•­
            > ì´ PRì—ì„œ ë³€ê²½ëœ ë‚´ìš©ì„ ê°„ê²°í•˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”.

            ## #ï¸âƒ£ ê´€ë ¨ ì´ìŠˆ
            - Closes #
            - Related to #

            ## #ï¸âƒ£ ì‘ì—… ìƒì„¸ ë‚´ìš©
            - 

            ## ğŸ“¸ ìŠ¤í¬ë¦°ìƒ· (ì„ íƒ)
            ### ë³€ê²½ ì „
            ### ë³€ê²½ í›„
            ## ğŸ“ ì°¸ê³ í• ë§Œí•œ ìë£Œ (ì„ íƒ)
            `;

            // 3. Gemini API í˜¸ì¶œ
            const model = "gemini-1.5-flash"; // ìµœì‹  ì•ˆì •í™” ëª¨ë¸ëª… ê¶Œì¥
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;

            try {
              const response = await fetch(url, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-goog-api-key': process.env.GEMINI_API_KEY
                },
                body: JSON.stringify({
                  contents: [{
                    parts: [{
                      text: `ë„ˆëŠ” ìœ ëŠ¥í•œ ì†Œí”„íŠ¸ì›¨ì–´ ì—”ì§€ë‹ˆì–´ë‹¤. ì•„ë˜ ì œê³µëœ ì»¤ë°‹ ë‚´ì—­ê³¼ ì½”ë“œ ë³€ê²½ ì‚¬í•­ì„ ë¶„ì„í•˜ì—¬ ì£¼ì–´ì§„ 'PR í…œí”Œë¦¿ í˜•ì‹'ì— ë§ì¶° PR ë³¸ë¬¸ì„ ì‘ì„±í•´ë¼. í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ê³ , ê¸°ìˆ ì ì¸ ìš©ì–´ëŠ” ì •í™•í•˜ê²Œ ì‚¬ìš©í•´ë¼. 

                      [PR í…œí”Œë¦¿ í˜•ì‹]
                      ${PR_TEMPLATE}

                      [ì»¤ë°‹ ë©”ì‹œì§€ ëª©ë¡]
                      ${commits}

                      [ë³€ê²½ íŒŒì¼ ìš”ì•½]
                      ${diffStat}

                      [ìƒì„¸ ì½”ë“œ ë³€ê²½ ë‚´ìš©]
                      ${diff}`
                    }]
                  }]
                })
              });

              const data = await response.json();
              if (data.error) throw new Error(data.error.message);
              
              const summary = data.candidates?.[0]?.content?.parts?.[0]?.text || "ìš”ì•½ ìƒì„± ì‹¤íŒ¨";

              // 4. PR ë³¸ë¬¸ ì—…ë°ì´íŠ¸ (ë°±í‹± ë‚´ë¶€ì˜ ë°±í‹±ì€ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬)
              const footer = `
            
---
> **AI ìë™ ìƒì„± ê²°ê³¼** (ë‚´ìš© í™•ì¸ í›„ ì‚­ì œ ë° ìˆ˜ì •í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”)

\`\`\`
âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- ì½”ë“œê°€ í”„ë¡œì íŠ¸ì˜ ì½”ë”© ì»¨ë²¤ì…˜ì„ ë”°ë¦…ë‹ˆë‹¤
- ë¬¸ì„œë¥¼ ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤ (í•„ìš”í•œ ê²½ìš°)
- ê´€ë ¨ ì´ìŠˆë¥¼ ì—°ê²°í–ˆìŠµë‹ˆë‹¤
\`\`\`
`;

              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                body: summary + footer
              });

            } catch (error) {
              console.error("Error during Gemini API call or PR update:", error);
            }
