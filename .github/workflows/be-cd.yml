name: Backend CD

on:
  push:
    branches:
      - main
      - feature/#13
    paths:
      - "backend/**"
      - "nginx/**"
      - "docker-compose.yml"

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. AWS OIDC 인증
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_ROLE_NAME }}
          aws-region: ap-northeast-2

      # 2. 백엔드 JAR 빌드
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: corretto
          java-version: 17
          cache: gradle

      - name: Build with Gradle
        working-directory: backend
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      # 3. Buildx 설정
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          platforms: linux/arm64
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/checkmate-be:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 4. 설정 파일 전송 (S3 임시 보관)
      - name: Upload Config to S3
        run: |
          mkdir -p nginx/certs
          # GitHub Secrets에서 인증서 내용을 가져와 파일로 생성
          echo "${{ secrets.SSL_CERTIFICATE }}" > nginx/certs/fullchain.crt
          echo "${{ secrets.SSL_PRIVATE_KEY }}" > nginx/certs/private.key
          
          # 인증서 폴더를 포함하여 압축
          zip -r deploy.zip docker-compose.yml nginx/default.conf nginx/certs/
          aws s3 cp deploy.zip s3://${{ secrets.S3_BUCKET_NAME }}/deploy.zip --sse AES256

      # 5. SSM으로 EC2에 명령
      - name: AWS SSM Send Command
        run: |
          aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "mkdir -p ~/app",
              "cd ~/app",
              "aws s3 cp s3://${{ secrets.S3_BUCKET_NAME }}/deploy.zip . --sse AES256",
              "unzip -o deploy.zip",
              "chmod 600 nginx/certs/private.key",
              "echo \"DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}\" > .env",
              "echo \"SPRING_PROFILES_ACTIVE=prod\" >> .env",
              "echo \"DB_URL=${{ secrets.DB_URL }}\" >> .env",
              "echo \"DB_USERNAME=${{ secrets.DB_USERNAME }}\" >> .env",
              "echo \"DB_PASSWORD=${{ secrets.DB_PASSWORD }}\" >> .env",
              "echo \"GOOGLE_ID=${{ secrets.GOOGLE_ID }}\" >> .env",
              "echo \"GOOGLE_SECRET=${{ secrets.GOOGLE_SECRET }}\" >> .env",
              "echo \"JWT_SECRET=${{ secrets.JWT_SECRET }}\" >> .env",
              "echo \"ENC_KEY=${{ secrets.ENC_KEY }}\" >> .env",
              "docker-compose pull",
              "docker-compose up -d",
              "docker image prune -f",
              "rm deploy.zip"
            ]' \
            --region ap-northeast-2